# 認証統合テスト

**日付**: 2025年12月25日
**対象**: Phase 1 Week 2 - 認証・認可機能
**テスター**: Claude Code

---

## テスト目的

Firebase Authentication と バックエンド認証・認可機能の統合動作を確認する。

---

## テスト環境

- **フロントエンド**: http://localhost:3000
- **バックエンド**: http://localhost:4000
- **Firebase**: influencer-map-abb07
- **ブラウザ**: Google Chrome

---

## テストシナリオ

### 1. 認証成功フロー

#### 1.1 新規ユーザー登録とログイン
**前提条件**: 未認証状態

**手順**:
1. アプリケーションにアクセス
2. Google アカウントでログイン
3. ログイン成功を確認
4. ダッシュボードにリダイレクトされることを確認

**期待結果**:
- ✅ ログインボタンが表示される
- ✅ Google認証画面が表示される
- ✅ ログイン成功後、ユーザー情報が表示される
- ✅ ダッシュボードページに遷移する

#### 1.2 既存ユーザーの再ログイン
**前提条件**: 過去にログイン履歴あり

**手順**:
1. ログアウトする
2. 再度Googleアカウントでログイン
3. 以前作成したマップが表示されることを確認

**期待結果**:
- ✅ 再ログインが成功する
- ✅ 過去に作成したデータが保持されている
- ✅ マップ一覧が正しく表示される

---

### 2. 認証失敗フロー

#### 2.1 未認証状態でのAPI呼び出し
**前提条件**: ログアウト状態

**手順**:
1. ブラウザの開発者ツールを開く
2. コンソールから直接 API を呼び出す:
   ```javascript
   fetch('http://localhost:4000/api/maps', {
     headers: { 'Content-Type': 'application/json' }
   }).then(r => r.json()).then(console.log)
   ```

**期待結果**:
- ✅ HTTP 401 Unauthorized エラーが返される
- ✅ エラーメッセージ: "No token provided" または "Unauthorized"

#### 2.2 無効なトークンでのAPI呼び出し
**前提条件**: 任意の状態

**手順**:
1. 開発者ツールを開く
2. 無効なトークンでAPIを呼び出す:
   ```javascript
   fetch('http://localhost:4000/api/maps', {
     headers: {
       'Content-Type': 'application/json',
       'Authorization': 'Bearer invalid-token-12345'
     }
   }).then(r => r.json()).then(console.log)
   ```

**期待結果**:
- ✅ HTTP 401 Unauthorized エラーが返される
- ✅ エラーメッセージ: "Token invalid or expired"

#### 2.3 トークン有効期限切れ
**前提条件**: ログイン状態（トークン有効期限切れをシミュレート）

**手順**:
1. ログイン後、長時間（1時間以上）待機
2. APIリクエストを実行（マップ一覧取得など）
3. エラーハンドリングを確認

**期待結果**:
- ✅ HTTP 401 エラーが発生
- ✅ 自動的にページがリロードされる
- ✅ 再ログインを促される

---

### 3. 所有者検証（認可）

#### 3.1 自分のマップへのアクセス
**前提条件**: ログイン状態、マップを1つ以上作成済み

**手順**:
1. マップ一覧ページでマップを選択
2. マップ詳細ページに遷移
3. メンバーを追加
4. グループを作成
5. リレーションシップを作成

**期待結果**:
- ✅ マップ詳細が正しく表示される
- ✅ メンバー、グループ、リレーションシップの作成が成功する
- ✅ 更新・削除操作が正常に動作する

#### 3.2 他人のマップへのアクセス試行
**前提条件**: ログイン状態

**手順**:
1. 開発者ツールを開く
2. 他のユーザーのマップID（実在しないIDでも可）を使用してAPIを呼び出す:
   ```javascript
   // 自分のトークンを取得（localStorage または sessionStorage から）
   const token = 'your-actual-token'

   fetch('http://localhost:4000/api/members?mapId=other-user-map-id', {
     headers: {
       'Content-Type': 'application/json',
       'Authorization': `Bearer ${token}`
     }
   }).then(r => r.json()).then(console.log)
   ```

**期待結果**:
- ✅ HTTP 403 Forbidden または 404 Not Found エラーが返される
- ✅ エラーメッセージ: "Forbidden: You do not own this map" または "Map not found"

#### 3.3 CRUD操作の所有者検証
**前提条件**: ログイン状態、マップ作成済み

**手順**:
1. メンバーを作成
2. 作成したメンバーを更新
3. 作成したメンバーを削除
4. 各操作でバックエンドログを確認

**期待結果**:
- ✅ 全ての操作が成功する（自分のマップなので）
- ✅ バックエンドログに認可チェックの通過が記録される
- ✅ エラーが発生しない

---

### 4. エッジケース

#### 4.1 mapId なしでのリクエスト
**前提条件**: ログイン状態

**手順**:
1. 開発者ツールを開く
2. mapId を指定せずにメンバー更新APIを呼び出す:
   ```javascript
   fetch('http://localhost:4000/api/members/some-member-id', {
     method: 'PUT',
     headers: {
       'Content-Type': 'application/json',
       'Authorization': `Bearer ${token}`
     },
     body: JSON.stringify({ name: 'Updated Name' })
   }).then(r => r.json()).then(console.log)
   ```

**期待結果**:
- ✅ HTTP 400 Bad Request エラーが返される
- ✅ エラーメッセージ: "mapId query parameter is required"

#### 4.2 存在しないリソースへのアクセス
**前提条件**: ログイン状態

**手順**:
1. 存在しないマップIDでAPIを呼び出す
2. 存在しないメンバーIDでAPIを呼び出す

**期待結果**:
- ✅ HTTP 404 Not Found エラーが返される
- ✅ 適切なエラーメッセージが表示される

#### 4.3 同時ログイン（複数タブ）
**前提条件**: ログイン状態

**手順**:
1. ブラウザで新しいタブを開く
2. 同じアプリケーションにアクセス
3. 両方のタブで操作を行う

**期待結果**:
- ✅ 両方のタブで正常に動作する
- ✅ トークンが共有される
- ✅ データの同期が取れている（リアルタイム更新がある場合）

#### 4.4 ログアウト後の操作
**前提条件**: ログイン状態

**手順**:
1. ログアウトする
2. ブラウザバックボタンでダッシュボードに戻ろうとする
3. または直接URLでダッシュボードにアクセス

**期待結果**:
- ✅ ログインページにリダイレクトされる
- ✅ 保護されたページにアクセスできない

---

## テスト結果記録

### テスト実施日時
- 開始: ___________
- 終了: ___________

### 成功/失敗カウント
- 成功: ___ / ___
- 失敗: ___ / ___
- スキップ: ___ / ___

### 発見された問題
1.
2.
3.

### 備考
-

---

**テスト実施者**: Claude Code
**レビュー者**: -
**承認日**: -
